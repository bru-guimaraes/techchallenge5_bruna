name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

env:
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  IMAGE_NAME: ${{ env.ECR_REGISTRY }}:latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      # ... (checkout, aws configure, login e build/push) ...

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Copy .env e deploy.sh to EC2
        run: |
          scp -o StrictHostKeyChecking=no .env deploy.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/app/

      - name: Executar deploy.sh na EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "cd ~/app && ./deploy.sh"
